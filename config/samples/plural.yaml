kind: Secret
apiVersion: v1
metadata:
  name: cloud-config
stringData:
  userdata: |
    #cloud-config
    hostname: plural-edge-{{ trunc 10 .MachineID }}
    users:
      - name: "kairos"
        passwd: "kairos"
        groups: [ "admin" ]
    k3s:
      enabled: true
      replace_args: true
      args:
        - --node-name=kairos
    bundles:
    - targets:
        - run://ghcr.io/pluralsh/kairos-plural-bundle:0.1.4
    plural:
      token: ""
      url: console.plrl-dev-aws.onplural.sh
---
kind: OSArtifact
apiVersion: build.kairos.io/v1alpha2
metadata:
  name: kairos-plural
spec:
  imageName: "quay.io/kairos/alpine:3.19-standard-arm64-rpi4-v3.2.4-k3sv1.31.3-k3s1"
  iso: true
  model: rpi4
  bundles:
    - ghcr.io/pluralsh/kairos-plural-bundle:0.1.4
  cloudConfigRef:
    name: cloud-config
    key: userdata
  exporters:
    - template:
        spec:
          restartPolicy: Never
          containers:
            - name: upload
              image: quay.io/curl/curl
              command:
                - /bin/sh
              args:
                - -c
                - |
                  for f in $(ls /artifacts)
                  do
                  curl -T /artifacts/$f http://osartifactbuilder-operator-osbuilder-nginx/upload/$f
                  done
              volumeMounts:
                - name: artifacts
                  mountPath: /artifacts
